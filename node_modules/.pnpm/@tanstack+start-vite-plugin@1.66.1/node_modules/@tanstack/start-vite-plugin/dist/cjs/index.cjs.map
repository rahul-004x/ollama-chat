{"version":3,"file":"index.cjs","sources":["../../src/index.ts"],"sourcesContent":["import { fileURLToPath, pathToFileURL } from 'node:url'\nimport {\n  compileCreateServerFnOutput,\n  compileEliminateDeadCode,\n} from './compilers'\nimport type { Plugin } from 'vite'\n\nconst debug = Boolean(process.env.TSR_VITE_DEBUG)\n\nexport function TanStackStartVite(): Array<Plugin> {\n  return [TanStackStartViteCreateServerFn()]\n}\n\nexport function TanStackStartViteCreateServerFn(): Plugin {\n  let ROOT: string = process.cwd()\n\n  return {\n    name: 'vite-plugin-tanstack-start-create-server-fn',\n    enforce: 'pre',\n    configResolved: (config) => {\n      ROOT = config.root\n    },\n    transform(code, id) {\n      const url = pathToFileURL(id)\n      url.searchParams.delete('v')\n      id = fileURLToPath(url).replace(/\\\\/g, '/')\n\n      if (code.includes('createServerFn')) {\n        if (code.includes('@react-refresh')) {\n          throw new Error(\n            `We detected that the '@vitejs/plugin-react' was passed before '@tanstack/start-vite-plugin'. Please make sure that '@tanstack/router-vite-plugin' is passed before '@vitejs/plugin-react' and try again: \ne.g.\n\nplugins: [\n  TanStackStartVite(), // Place this before viteReact()\n  viteReact(),\n]\n`,\n          )\n        }\n\n        if (debug) console.info('Handling createServerFn for id: ', id)\n\n        const compiled = compileCreateServerFnOutput({\n          code,\n          root: ROOT,\n          filename: id,\n        })\n\n        if (debug) console.info('')\n        if (debug) console.info('Compiled createServerFn Output')\n        if (debug) console.info('')\n        if (debug) console.info(compiled.code)\n        if (debug) console.info('')\n        if (debug) console.info('')\n        if (debug) console.info('')\n\n        return compiled\n      }\n\n      return null\n    },\n  }\n}\n\nexport function TanStackStartViteDeadCodeElimination(): Plugin {\n  let ROOT: string = process.cwd()\n\n  return {\n    name: 'vite-plugin-tanstack-start-dead-code-elimination',\n    enforce: 'post',\n    configResolved: (config) => {\n      ROOT = config.root\n    },\n    transform(code, id) {\n      const url = pathToFileURL(id)\n      url.searchParams.delete('v')\n      id = fileURLToPath(url).replace(/\\\\/g, '/')\n\n      if (code.includes('createServerFn')) {\n        const compiled = compileEliminateDeadCode({\n          code,\n          root: ROOT,\n          filename: id,\n        })\n\n        if (debug) console.info('')\n        if (debug) console.info('Output after dead code elimination')\n        if (debug) console.info('')\n        if (debug) console.info(compiled.code)\n        if (debug) console.info('')\n        if (debug) console.info('')\n        if (debug) console.info('')\n\n        return compiled\n      }\n\n      return null\n    },\n  }\n}\n"],"names":["pathToFileURL","fileURLToPath","compileCreateServerFnOutput","compileEliminateDeadCode"],"mappings":";;;;AAOA,MAAM,QAAQ,QAAQ,QAAQ,IAAI,cAAc;AAEzC,SAAS,oBAAmC;AAC1C,SAAA,CAAC,iCAAiC;AAC3C;AAEO,SAAS,kCAA0C;AACpD,MAAA,OAAe,QAAQ;AAEpB,SAAA;AAAA,IACL,MAAM;AAAA,IACN,SAAS;AAAA,IACT,gBAAgB,CAAC,WAAW;AAC1B,aAAO,OAAO;AAAA,IAChB;AAAA,IACA,UAAU,MAAM,IAAI;AACZ,YAAA,MAAMA,uBAAc,EAAE;AACxB,UAAA,aAAa,OAAO,GAAG;AAC3B,WAAKC,SAAc,cAAA,GAAG,EAAE,QAAQ,OAAO,GAAG;AAEtC,UAAA,KAAK,SAAS,gBAAgB,GAAG;AAC/B,YAAA,KAAK,SAAS,gBAAgB,GAAG;AACnC,gBAAM,IAAI;AAAA,YACR;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAAA;AAAA,QASJ;AAEA,YAAI,MAAO,SAAQ,KAAK,oCAAoC,EAAE;AAE9D,cAAM,WAAWC,UAAAA,4BAA4B;AAAA,UAC3C;AAAA,UACA,MAAM;AAAA,UACN,UAAU;AAAA,QAAA,CACX;AAEG,YAAA,MAAe,SAAA,KAAK,EAAE;AACtB,YAAA,MAAe,SAAA,KAAK,gCAAgC;AACpD,YAAA,MAAe,SAAA,KAAK,EAAE;AAC1B,YAAI,MAAO,SAAQ,KAAK,SAAS,IAAI;AACjC,YAAA,MAAe,SAAA,KAAK,EAAE;AACtB,YAAA,MAAe,SAAA,KAAK,EAAE;AACtB,YAAA,MAAe,SAAA,KAAK,EAAE;AAEnB,eAAA;AAAA,MACT;AAEO,aAAA;AAAA,IACT;AAAA,EAAA;AAEJ;AAEO,SAAS,uCAA+C;AACzD,MAAA,OAAe,QAAQ;AAEpB,SAAA;AAAA,IACL,MAAM;AAAA,IACN,SAAS;AAAA,IACT,gBAAgB,CAAC,WAAW;AAC1B,aAAO,OAAO;AAAA,IAChB;AAAA,IACA,UAAU,MAAM,IAAI;AACZ,YAAA,MAAMF,uBAAc,EAAE;AACxB,UAAA,aAAa,OAAO,GAAG;AAC3B,WAAKC,SAAc,cAAA,GAAG,EAAE,QAAQ,OAAO,GAAG;AAEtC,UAAA,KAAK,SAAS,gBAAgB,GAAG;AACnC,cAAM,WAAWE,UAAAA,yBAAyB;AAAA,UACxC;AAAA,UACA,MAAM;AAAA,UACN,UAAU;AAAA,QAAA,CACX;AAEG,YAAA,MAAe,SAAA,KAAK,EAAE;AACtB,YAAA,MAAe,SAAA,KAAK,oCAAoC;AACxD,YAAA,MAAe,SAAA,KAAK,EAAE;AAC1B,YAAI,MAAO,SAAQ,KAAK,SAAS,IAAI;AACjC,YAAA,MAAe,SAAA,KAAK,EAAE;AACtB,YAAA,MAAe,SAAA,KAAK,EAAE;AACtB,YAAA,MAAe,SAAA,KAAK,EAAE;AAEnB,eAAA;AAAA,MACT;AAEO,aAAA;AAAA,IACT;AAAA,EAAA;AAEJ;;;;"}