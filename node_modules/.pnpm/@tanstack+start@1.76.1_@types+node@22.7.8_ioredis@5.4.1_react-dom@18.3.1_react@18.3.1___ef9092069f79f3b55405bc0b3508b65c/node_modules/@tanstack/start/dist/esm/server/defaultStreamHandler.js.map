{"version":3,"file":"defaultStreamHandler.js","sources":["../../../src/server/defaultStreamHandler.tsx"],"sourcesContent":["import { PassThrough } from 'node:stream'\nimport { isbot } from 'isbot'\nimport ReactDOMServer from 'react-dom/server'\nimport { StartServer } from './StartServer'\nimport {\n  transformReadableStreamWithRouter,\n  transformStreamWithRouter,\n} from './transformStreamWithRouter'\nimport type { AnyRouter } from '@tanstack/react-router'\n\nexport type HandlerCallback<TRouter extends AnyRouter> = (ctx: {\n  request: Request\n  router: TRouter\n  responseHeaders: Headers\n}) => Response | Promise<Response>\n\nexport const defaultStreamHandler: HandlerCallback<AnyRouter> = async ({\n  request,\n  router,\n  responseHeaders,\n}) => {\n  if (typeof ReactDOMServer.renderToReadableStream === 'function') {\n    const stream = await ReactDOMServer.renderToReadableStream(\n      <StartServer router={router} />,\n      {\n        signal: request.signal,\n        onError(error, errorInfo) {\n          console.error(error, errorInfo)\n        },\n      },\n    )\n\n    if (isbot(request.headers.get('User-Agent'))) {\n      await stream.allReady\n    }\n\n    const transforms = [transformReadableStreamWithRouter(router)]\n\n    const transformedStream = transforms.reduce(\n      (stream, transform) => stream.pipeThrough(transform),\n      stream as ReadableStream,\n    )\n\n    return new Response(transformedStream, {\n      status: router.state.statusCode,\n      headers: responseHeaders,\n    })\n  }\n\n  if (typeof ReactDOMServer.renderToPipeableStream === 'function') {\n    const passthrough = new PassThrough()\n\n    const pipeable = ReactDOMServer.renderToPipeableStream(\n      <StartServer router={router} />,\n      {\n        ...(isbot(request.headers.get('User-Agent'))\n          ? {\n              onAllReady() {\n                pipeable.pipe(passthrough)\n              },\n            }\n          : {\n              onShellReady() {\n                pipeable.pipe(passthrough)\n              },\n            }),\n        onShellError(err) {\n          throw err\n        },\n      },\n    )\n\n    const transforms = [transformStreamWithRouter(router)]\n\n    const transformedStream = transforms.reduce(\n      (stream, transform) => (stream as any).pipe(transform),\n      passthrough,\n    )\n\n    return new Response(transformedStream as any, {\n      status: router.state.statusCode,\n      headers: responseHeaders,\n    })\n  }\n\n  throw new Error(\n    'No renderToReadableStream or renderToPipeableStream found in react-dom/server. Ensure you are using a version of react-dom that supports streaming.',\n  )\n}\n"],"names":["stream"],"mappings":";;;;;;AAgBO,MAAM,uBAAmD,OAAO;AAAA,EACrE;AAAA,EACA;AAAA,EACA;AACF,MAAM;AACA,MAAA,OAAO,eAAe,2BAA2B,YAAY;AACzD,UAAA,SAAS,MAAM,eAAe;AAAA,MAClC,oBAAC,eAAY,QAAgB;AAAA,MAC7B;AAAA,QACE,QAAQ,QAAQ;AAAA,QAChB,QAAQ,OAAO,WAAW;AAChB,kBAAA,MAAM,OAAO,SAAS;AAAA,QAChC;AAAA,MACF;AAAA,IAAA;AAGF,QAAI,MAAM,QAAQ,QAAQ,IAAI,YAAY,CAAC,GAAG;AAC5C,YAAM,OAAO;AAAA,IACf;AAEA,UAAM,aAAa,CAAC,kCAAkC,MAAM,CAAC;AAE7D,UAAM,oBAAoB,WAAW;AAAA,MACnC,CAACA,SAAQ,cAAcA,QAAO,YAAY,SAAS;AAAA,MACnD;AAAA,IAAA;AAGK,WAAA,IAAI,SAAS,mBAAmB;AAAA,MACrC,QAAQ,OAAO,MAAM;AAAA,MACrB,SAAS;AAAA,IAAA,CACV;AAAA,EACH;AAEI,MAAA,OAAO,eAAe,2BAA2B,YAAY;AACzD,UAAA,cAAc,IAAI;AAExB,UAAM,WAAW,eAAe;AAAA,MAC9B,oBAAC,eAAY,QAAgB;AAAA,MAC7B;AAAA,QACE,GAAI,MAAM,QAAQ,QAAQ,IAAI,YAAY,CAAC,IACvC;AAAA,UACE,aAAa;AACX,qBAAS,KAAK,WAAW;AAAA,UAC3B;AAAA,QAAA,IAEF;AAAA,UACE,eAAe;AACb,qBAAS,KAAK,WAAW;AAAA,UAC3B;AAAA,QACF;AAAA,QACJ,aAAa,KAAK;AACV,gBAAA;AAAA,QACR;AAAA,MACF;AAAA,IAAA;AAGF,UAAM,aAAa,CAAC,0BAA0B,MAAM,CAAC;AAErD,UAAM,oBAAoB,WAAW;AAAA,MACnC,CAAC,QAAQ,cAAe,OAAe,KAAK,SAAS;AAAA,MACrD;AAAA,IAAA;AAGK,WAAA,IAAI,SAAS,mBAA0B;AAAA,MAC5C,QAAQ,OAAO,MAAM;AAAA,MACrB,SAAS;AAAA,IAAA,CACV;AAAA,EACH;AAEA,QAAM,IAAI;AAAA,IACR;AAAA,EAAA;AAEJ;"}