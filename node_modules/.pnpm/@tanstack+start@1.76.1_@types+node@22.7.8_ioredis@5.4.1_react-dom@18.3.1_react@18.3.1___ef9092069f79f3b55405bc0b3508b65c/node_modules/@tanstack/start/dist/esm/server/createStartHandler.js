import { eventHandler, toWebRequest, getResponseHeaders } from "vinxi/http";
import { createMemoryHistory } from "@tanstack/react-router";
import { serializeLoaderData } from "../client/serialization.js";
import { mergeHeaders } from "../client/headers.js";
import { serverFnReturnTypeHeader, serverFnPayloadTypeHeader } from "../constants.js";
function createStartHandler({
  createRouter,
  getRouterManifest
}) {
  return (cb) => {
    return eventHandler(async (event) => {
      const request = toWebRequest(event);
      const url = new URL(request.url);
      const href = url.href.replace(url.origin, "");
      const history = createMemoryHistory({
        initialEntries: [href]
      });
      const router = createRouter();
      router.serializeLoaderData = serializeLoaderData;
      if (getRouterManifest) {
        router.manifest = getRouterManifest();
      }
      router.update({
        history
      });
      await router.load();
      const responseHeaders = getRequestHeaders({
        event,
        router
      });
      const response = await cb({
        request,
        router,
        responseHeaders
      });
      return response;
    });
  };
}
function getRequestHeaders(opts) {
  opts.event.__tsrHeadersSent = true;
  let headers = mergeHeaders(
    getResponseHeaders(opts.event),
    {
      "Content-Type": "text/html; charset=UTF-8"
    },
    ...opts.router.state.matches.map((match) => {
      return match.headers;
    })
  );
  const { redirect } = opts.router.state;
  if (redirect) {
    headers = mergeHeaders(headers, redirect.headers, {
      Location: redirect.href
    });
  }
  [serverFnReturnTypeHeader, serverFnPayloadTypeHeader].forEach((header) => {
    headers.delete(header);
  });
  return headers;
}
export {
  createStartHandler
};
//# sourceMappingURL=createStartHandler.js.map
