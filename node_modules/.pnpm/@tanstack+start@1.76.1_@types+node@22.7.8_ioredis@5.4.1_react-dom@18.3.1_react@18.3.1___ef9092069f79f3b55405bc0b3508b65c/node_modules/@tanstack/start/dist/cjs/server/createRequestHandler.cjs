"use strict";
Object.defineProperty(exports, Symbol.toStringTag, { value: "Module" });
const reactRouter = require("@tanstack/react-router");
const serialization = require("../client/serialization.cjs");
const constants = require("../constants.cjs");
const headers = require("../client/headers.cjs");
function createRequestHandler({
  createRouter,
  request,
  getRouterManifest
}) {
  return async (cb) => {
    const router = createRouter();
    router.serializeLoaderData = serialization.serializeLoaderData;
    if (getRouterManifest) {
      router.manifest = getRouterManifest();
    }
    const url = new URL(request.url, "http://localhost");
    const href = url.href.replace(url.origin, "");
    const history = reactRouter.createMemoryHistory({
      initialEntries: [href]
    });
    router.update({
      history
    });
    await router.load();
    const responseHeaders = getRequestHeaders({
      router
    });
    return cb({
      request,
      router,
      responseHeaders
    });
  };
}
function getRequestHeaders(opts) {
  let headers$1 = headers.mergeHeaders(
    {
      "Content-Type": "text/html; charset=UTF-8"
    },
    ...opts.router.state.matches.map((match) => {
      return match.headers;
    })
  );
  const { redirect } = opts.router.state;
  if (redirect) {
    headers$1 = headers.mergeHeaders(headers$1, redirect.headers, {
      Location: redirect.href
    });
  }
  [constants.serverFnReturnTypeHeader, constants.serverFnPayloadTypeHeader].forEach((header) => {
    headers$1.delete(header);
  });
  return headers$1;
}
exports.createRequestHandler = createRequestHandler;
//# sourceMappingURL=createRequestHandler.cjs.map
